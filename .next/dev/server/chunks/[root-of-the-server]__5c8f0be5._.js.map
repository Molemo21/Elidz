{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/liqui/OneDrive/Desktop/ai-funding-platform/app/api/auth/sync-cookies/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createServerClient } from '@supabase/ssr'\nimport type { Database } from '@/lib/supabase/database.types'\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { accessToken, refreshToken } = await request.json()\n\n    if (!accessToken || !refreshToken) {\n      return NextResponse.json(\n        { success: false, error: 'Missing tokens' },\n        { status: 400 }\n      )\n    }\n\n    // Extract project reference from Supabase URL for cookie names\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || ''\n    const projectRef = supabaseUrl.split('//')[1]?.split('.')[0] || ''\n    \n    // Track if setAll was called\n    let setAllWasCalled = false\n    const cookiesToSet: Array<{ name: string; value: string; options: any }> = []\n\n    // Create mutable response that will be updated\n    let response = NextResponse.json({ success: true })\n\n    // Create Supabase client with cookie handling\n    const supabase = createServerClient<Database>(\n      supabaseUrl,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        cookies: {\n          getAll() {\n            return request.cookies.getAll()\n          },\n          setAll(cookies) {\n            setAllWasCalled = true\n            // Store cookies to set\n            cookies.forEach(cookie => {\n              cookiesToSet.push(cookie)\n            })\n            \n            // Create new response with cookies\n            response = NextResponse.json({ success: true })\n            \n            // Set all cookies on the response with proper options\n            cookies.forEach(({ name, value, options }) => {\n              response.cookies.set(name, value, {\n                ...options,\n                httpOnly: options?.httpOnly ?? true,\n                secure: options?.secure ?? (process.env.NODE_ENV === 'production'),\n                sameSite: (options?.sameSite as 'lax' | 'strict' | 'none') ?? 'lax',\n                path: options?.path ?? '/',\n                ...(options?.maxAge && { maxAge: options.maxAge }),\n              })\n            })\n          },\n        },\n      }\n    )\n\n    // IMPORTANT: setSession in API routes doesn't trigger setAll callback\n    // We need to manually set cookies in the exact format Supabase SSR expects\n    // First, validate the session by calling setSession\n    const { data: sessionData, error } = await supabase.auth.setSession({\n      access_token: accessToken,\n      refresh_token: refreshToken,\n    })\n\n    if (error) {\n      console.error('[sync-cookies] Failed to set session:', {\n        message: error.message,\n        status: error.status,\n        error,\n      })\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 500 }\n      )\n    }\n\n    if (!sessionData.session) {\n      console.error('[sync-cookies] No session returned after setSession')\n      return NextResponse.json(\n        { success: false, error: 'Failed to create session' },\n        { status: 500 }\n      )\n    }\n\n    // Check if setAll was called (it usually won't be in API routes)\n    let allCookies = response.cookies.getAll()\n    \n    // Always manually set cookies because setSession in API routes doesn't trigger setAll\n    // Supabase SSR expects cookies in a specific format\n    const sessionCookieName = `sb-${projectRef}-auth-token`\n    \n    // Supabase SSR stores the session as a JSON string in the cookie\n    // The format matches what's stored in localStorage\n    const sessionValue = {\n      access_token: accessToken,\n      refresh_token: refreshToken,\n      expires_at: sessionData.session.expires_at,\n      expires_in: sessionData.session.expires_in,\n      token_type: sessionData.session.token_type,\n      user: sessionData.session.user,\n    }\n    \n    // Calculate maxAge from expires_at (Unix timestamp)\n    const expiresAt = sessionData.session.expires_at\n    const maxAge = expiresAt \n      ? Math.max(0, expiresAt - Math.floor(Date.now() / 1000))\n      : 60 * 60 * 24 * 7 // Default to 7 days if no expires_at\n    \n    // Set the session cookie - this is what Supabase SSR reads\n    response.cookies.set(sessionCookieName, JSON.stringify(sessionValue), {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      sameSite: 'lax' as const,\n      path: '/',\n      maxAge: maxAge,\n    })\n    \n    // Supabase SSR may also look for code verifier cookies, but the main auth token is critical\n    // We can optionally set additional cookies if needed, but the auth-token cookie should be sufficient\n    \n    // Verify cookies were set\n    allCookies = response.cookies.getAll()\n    console.log('[sync-cookies] After setting cookies, count:', allCookies.length)\n\n    // Log what cookies were set\n    const cookieNames = allCookies.map(c => c.name).join(', ')\n    console.log('[sync-cookies] setAll was called:', setAllWasCalled)\n    console.log('[sync-cookies] Cookies set:', cookieNames || 'None')\n    console.log('[sync-cookies] Session user:', sessionData.session.user.email)\n    console.log('[sync-cookies] Total cookies in response:', allCookies.length)\n\n    // Debug: Log cookie details\n    if (allCookies.length > 0) {\n      allCookies.forEach(cookie => {\n        const valuePreview = cookie.value.length > 50 \n          ? `${cookie.value.substring(0, 50)}...` \n          : cookie.value\n        console.log(`[sync-cookies] Cookie: ${cookie.name} (${cookie.value.length} chars)`)\n      })\n    } else {\n      console.error('[sync-cookies] ERROR: No cookies were set in the response!')\n    }\n\n    return response\n  } catch (error: any) {\n    console.error('[sync-cookies] API route error:', error)\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}