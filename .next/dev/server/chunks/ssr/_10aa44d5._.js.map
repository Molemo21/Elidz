{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/liqui/OneDrive/Desktop/ai-funding-platform/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\r\nimport { cookies } from 'next/headers'\r\nimport type { Database } from './database.types'\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient<Database>(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return cookieStore.getAll()\r\n        },\r\n        setAll(cookiesToSet) {\r\n          try {\r\n            cookiesToSet.forEach(({ name, value, options }) =>\r\n              cookieStore.set(name, value, options)\r\n            )\r\n          } catch {\r\n            // The `setAll` method was called from a Server Component.\r\n            // This can be ignored if you have middleware refreshing\r\n            // user sessions.\r\n          }\r\n        },\r\n      },\r\n    }\r\n  )\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,yQAAO;IAEjC,OAAO,IAAA,sSAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/liqui/OneDrive/Desktop/ai-funding-platform/app/actions/create-user-record.ts"],"sourcesContent":["'use server'\r\n\r\nimport { createClient } from '@/lib/supabase/server'\r\n\r\n/**\r\n * Server action to create user record after signup\r\n * Uses the system function via RPC which bypasses RLS\r\n * This is a reliable backup in case the trigger doesn't fire immediately\r\n */\r\nexport async function createUserRecord(userId: string, userData: {\r\n  email: string\r\n  role: 'smme' | 'admin'\r\n  firstName: string\r\n  lastName: string\r\n  phone: string\r\n}) {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    // Check if user record already exists\r\n    const { data: existingUser } = await supabase\r\n      .from('users')\r\n      .select('id')\r\n      .eq('id', userId)\r\n      .maybeSingle()\r\n\r\n    if (existingUser) {\r\n      return {\r\n        success: true,\r\n        message: 'User record already exists',\r\n        data: existingUser,\r\n      }\r\n    }\r\n\r\n    // Use the system function via RPC (bypasses RLS)\r\n    // This function uses SECURITY DEFINER and doesn't require auth check\r\n    const { data, error } = await (supabase as any).rpc('create_user_record_system', {\r\n      user_id: userId,\r\n      user_email: userData.email,\r\n      user_role: userData.role,\r\n      user_first_name: userData.firstName,\r\n      user_last_name: userData.lastName,\r\n      user_phone: userData.phone,\r\n    })\r\n\r\n    if (error) {\r\n      // If duplicate key error, record exists (race condition - trigger created it)\r\n      if (error.code === '23505') {\r\n        return {\r\n          success: true,\r\n          message: 'User record already exists (created by trigger)',\r\n        }\r\n      }\r\n\r\n      console.error('Failed to create user record via RPC:', {\r\n        code: error.code,\r\n        message: error.message,\r\n        details: error.details,\r\n      })\r\n\r\n      return {\r\n        success: false,\r\n        error: error.message || 'Failed to create user record',\r\n      }\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      message: 'User record created successfully',\r\n      data: { id: data || userId },\r\n    }\r\n  } catch (error: any) {\r\n    console.error('Error in createUserRecord:', error)\r\n    return {\r\n      success: false,\r\n      error: error.message || 'Failed to create user record',\r\n    }\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;AAEA;;;;AAOO,eAAe,iBAAiB,MAAc,EAAE,QAMtD;IACC,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,yIAAY;QAEnC,sCAAsC;QACtC,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,SAClC,IAAI,CAAC,SACL,MAAM,CAAC,MACP,EAAE,CAAC,MAAM,QACT,WAAW;QAEd,IAAI,cAAc;YAChB,OAAO;gBACL,SAAS;gBACT,SAAS;gBACT,MAAM;YACR;QACF;QAEA,iDAAiD;QACjD,qEAAqE;QACrE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,AAAC,SAAiB,GAAG,CAAC,6BAA6B;YAC/E,SAAS;YACT,YAAY,SAAS,KAAK;YAC1B,WAAW,SAAS,IAAI;YACxB,iBAAiB,SAAS,SAAS;YACnC,gBAAgB,SAAS,QAAQ;YACjC,YAAY,SAAS,KAAK;QAC5B;QAEA,IAAI,OAAO;YACT,8EAA8E;YAC9E,IAAI,MAAM,IAAI,KAAK,SAAS;gBAC1B,OAAO;oBACL,SAAS;oBACT,SAAS;gBACX;YACF;YAEA,QAAQ,KAAK,CAAC,yCAAyC;gBACrD,MAAM,MAAM,IAAI;gBAChB,SAAS,MAAM,OAAO;gBACtB,SAAS,MAAM,OAAO;YACxB;YAEA,OAAO;gBACL,SAAS;gBACT,OAAO,MAAM,OAAO,IAAI;YAC1B;QACF;QAEA,OAAO;YACL,SAAS;YACT,SAAS;YACT,MAAM;gBAAE,IAAI,QAAQ;YAAO;QAC7B;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;YACL,SAAS;YACT,OAAO,MAAM,OAAO,IAAI;QAC1B;IACF;AACF;;;IArEsB;;AAAA,8WAAA"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/liqui/OneDrive/Desktop/ai-funding-platform/lib/supabase/auth-helpers.ts"],"sourcesContent":["import { createClient } from './server'\r\nimport { redirect } from 'next/navigation'\r\nimport type { AuthUser } from '@/lib/auth'\r\n\r\nexport async function getServerSession(): Promise<AuthUser | null> {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Try getSession first - this reads from cookies\r\n    const { data: { session }, error: sessionError } = await supabase.auth.getSession()\r\n    \r\n    if (sessionError) {\r\n      console.error('[getServerSession] Session error:', {\r\n        message: sessionError.message,\r\n        status: sessionError.status,\r\n        code: sessionError.status,\r\n      })\r\n    }\r\n    \r\n    // If we have a session, use it\r\n    if (session?.user) {\r\n      console.log('[getServerSession] Session found via getSession(), user ID:', session.user.id)\r\n      const { data: profile, error: profileError } = await supabase\r\n        .from('users')\r\n        .select('id, email, role, first_name, last_name, approved')\r\n        .eq('id', session.user.id)\r\n        .maybeSingle()\r\n\r\n      if (profileError) {\r\n        console.error('[getServerSession] Profile query error:', {\r\n          message: profileError.message,\r\n          code: profileError.code,\r\n          details: profileError.details,\r\n        })\r\n        return null\r\n      }\r\n\r\n      if (!profile) {\r\n        console.warn('[getServerSession] Profile not found for user:', session.user.id)\r\n        return null\r\n      }\r\n\r\n      return {\r\n        id: profile.id,\r\n        email: profile.email,\r\n        role: profile.role,\r\n        name: `${profile.first_name} ${profile.last_name}`,\r\n        approved: profile.approved,\r\n      }\r\n    }\r\n    \r\n    // Fallback: try getUser() which might work if session is in headers\r\n    // This is more reliable as it validates the token\r\n    console.log('[getServerSession] No session from getSession(), trying getUser()...')\r\n    const { data: { user }, error } = await supabase.auth.getUser()\r\n    \r\n    if (error) {\r\n      // Log error but don't treat it as fatal - might be missing cookies\r\n      console.log('[getServerSession] getUser() error (this is normal if cookies not synced):', {\r\n        message: error.message,\r\n        status: error.status,\r\n      })\r\n      return null\r\n    }\r\n    \r\n    if (!user) {\r\n      console.log('[getServerSession] No user found via getUser()')\r\n      return null\r\n    }\r\n    \r\n    console.log('[getServerSession] User found via getUser(), user ID:', user.id)\r\n\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from('users')\r\n      .select('id, email, role, first_name, last_name, approved')\r\n      .eq('id', user.id)\r\n      .maybeSingle()\r\n\r\n    if (profileError) {\r\n      console.error('[getServerSession] Profile query error:', {\r\n        message: profileError.message,\r\n        code: profileError.code,\r\n        details: profileError.details,\r\n      })\r\n      return null\r\n    }\r\n\r\n    if (!profile) {\r\n      console.warn('[getServerSession] Profile not found for user:', user.id)\r\n      return null\r\n    }\r\n\r\n    return {\r\n      id: profile.id,\r\n      email: profile.email,\r\n      role: profile.role,\r\n      name: `${profile.first_name} ${profile.last_name}`,\r\n      approved: profile.approved,\r\n    }\r\n  } catch (error: any) {\r\n    // Catch any unexpected errors\r\n    console.error('[getServerSession] Unexpected error:', {\r\n      message: error?.message,\r\n      stack: error?.stack,\r\n    })\r\n    return null\r\n  }\r\n}\r\n\r\nexport async function requireAuth(): Promise<AuthUser> {\r\n  const session = await getServerSession()\r\n  \r\n  if (!session) {\r\n    redirect('/login')\r\n  }\r\n  \r\n  return session\r\n}\r\n\r\nexport async function requireAdmin(): Promise<AuthUser> {\r\n  const session = await getServerSession()\r\n  \r\n  if (!session) {\r\n    redirect('/login')\r\n  }\r\n  \r\n  if (session.role !== 'admin') {\r\n    redirect('/dashboard')\r\n  }\r\n  \r\n  return session\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 224, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/liqui/OneDrive/Desktop/ai-funding-platform/app/actions/user-profiles.ts"],"sourcesContent":["'use server'\r\n\r\nimport { getServerSession } from '@/lib/supabase/auth-helpers'\r\nimport { userProfileQueries } from '@/lib/db/queries'\r\nimport { userProfileSchema, validateWithZod } from '@/lib/validations/schemas'\r\nimport type { FundingRequirements } from '@/lib/db-schema'\r\nimport type { UserProfileResponse } from './types'\r\n\r\n/**\r\n * Input type for creating/updating user profile\r\n * @deprecated Use UserProfileInput from lib/validations/schemas instead\r\n * Kept for backward compatibility\r\n */\r\nexport interface UserProfileInput {\r\n  company_name: string\r\n  registration_number: string\r\n  industry: string\r\n  business_description: string\r\n  annual_revenue: number\r\n  employees_count: number\r\n  years_in_business: number\r\n  location: string\r\n  funding_requirements: FundingRequirements\r\n}\r\n\r\n// Re-export for convenience\r\nexport type { UserProfileInput as UserProfileInputType } from '@/lib/validations/schemas'\r\nexport type { UserProfileResponse }\r\n\r\n/**\r\n * Get user's profile from database\r\n */\r\nexport async function getUserProfile(): Promise<UserProfileResponse> {\r\n  try {\r\n    // Use getServerSession instead of requireAuth to avoid redirect issues\r\n    const user = await getServerSession()\r\n    if (!user) {\r\n      return { success: false, error: 'Authentication required. Please log in.' }\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    const { data: profile, error } = await supabase\r\n      .from('user_profiles')\r\n      .select('*')\r\n      .eq('user_id', user.id)\r\n      .maybeSingle()\r\n\r\n    if (error) {\r\n      console.error('Error fetching user profile:', error)\r\n      return { success: false, error: error.message }\r\n    }\r\n\r\n    return { success: true, data: profile }\r\n  } catch (error: any) {\r\n    // Check if this is a Next.js redirect error - if so, re-throw it\r\n    if (error && typeof error === 'object' && 'digest' in error && error.digest?.startsWith('NEXT_REDIRECT')) {\r\n      throw error\r\n    }\r\n    console.error('Error in getUserProfile:', error)\r\n    return { success: false, error: error.message || 'Failed to fetch profile' }\r\n  }\r\n}\r\n\r\n/**\r\n * Create a new user profile\r\n */\r\nexport async function createUserProfile(input: UserProfileInput): Promise<UserProfileResponse> {\r\n  try {\r\n    // Use getServerSession instead of requireAuth to avoid redirect issues\r\n    const user = await getServerSession()\r\n    if (!user) {\r\n      return { success: false, error: 'Authentication required. Please log in.' }\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    // Validate required fields\r\n    if (!input.company_name || !input.registration_number || !input.industry) {\r\n      return { success: false, error: 'Missing required fields' }\r\n    }\r\n\r\n    const { data: profile, error } = await supabase\r\n      .from('user_profiles')\r\n      .insert({\r\n        user_id: user.id,\r\n        company_name: input.company_name,\r\n        registration_number: input.registration_number,\r\n        industry: input.industry,\r\n        business_description: input.business_description,\r\n        annual_revenue: input.annual_revenue,\r\n        employees_count: input.employees_count,\r\n        years_in_business: input.years_in_business,\r\n        location: input.location,\r\n        funding_requirements: input.funding_requirements as any, // JSONB field\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error('Error creating user profile:', error)\r\n      \r\n      // Handle unique constraint violation (profile already exists)\r\n      if (error.code === '23505') {\r\n        return { success: false, error: 'Profile already exists. Use update instead.' }\r\n      }\r\n      \r\n      return { success: false, error: error.message }\r\n    }\r\n\r\n    return { success: true, data: profile }\r\n  } catch (error: any) {\r\n    // Check if this is a Next.js redirect error - if so, re-throw it\r\n    if (error && typeof error === 'object' && 'digest' in error && error.digest?.startsWith('NEXT_REDIRECT')) {\r\n      throw error\r\n    }\r\n    console.error('Error in createUserProfile:', error)\r\n    return { success: false, error: error.message || 'Failed to create profile' }\r\n  }\r\n}\r\n\r\n/**\r\n * Update existing user profile\r\n */\r\nexport async function updateUserProfile(input: Partial<UserProfileInput>): Promise<UserProfileResponse> {\r\n  try {\r\n    // Use getServerSession instead of requireAuth to avoid redirect issues\r\n    const user = await getServerSession()\r\n    if (!user) {\r\n      return { success: false, error: 'Authentication required. Please log in.' }\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    // Build update object, only including provided fields\r\n    const updateData: any = {}\r\n\r\n    if (input.company_name !== undefined) updateData.company_name = input.company_name\r\n    if (input.registration_number !== undefined) updateData.registration_number = input.registration_number\r\n    if (input.industry !== undefined) updateData.industry = input.industry\r\n    if (input.business_description !== undefined) updateData.business_description = input.business_description\r\n    if (input.annual_revenue !== undefined) updateData.annual_revenue = input.annual_revenue\r\n    if (input.employees_count !== undefined) updateData.employees_count = input.employees_count\r\n    if (input.years_in_business !== undefined) updateData.years_in_business = input.years_in_business\r\n    if (input.location !== undefined) updateData.location = input.location\r\n    if (input.funding_requirements !== undefined) {\r\n      updateData.funding_requirements = input.funding_requirements as any\r\n    }\r\n\r\n    // Check if profile exists first\r\n    const { data: existingProfile } = await supabase\r\n      .from('user_profiles')\r\n      .select('id')\r\n      .eq('user_id', user.id)\r\n      .maybeSingle()\r\n\r\n    let result\r\n    if (existingProfile) {\r\n      // Update existing profile\r\n      const { data: profile, error } = await supabase\r\n        .from('user_profiles')\r\n        .update(updateData)\r\n        .eq('user_id', user.id)\r\n        .select()\r\n        .single()\r\n\r\n      if (error) {\r\n        console.error('Error updating user profile:', error)\r\n        return { success: false, error: error.message }\r\n      }\r\n\r\n      result = { success: true, data: profile }\r\n    } else {\r\n      // Create new profile if doesn't exist (upsert behavior)\r\n      const { data: profile, error } = await supabase\r\n        .from('user_profiles')\r\n        .insert({\r\n          user_id: user.id,\r\n          ...updateData,\r\n        })\r\n        .select()\r\n        .single()\r\n\r\n      if (error) {\r\n        console.error('Error creating user profile during update:', error)\r\n        return { success: false, error: error.message }\r\n      }\r\n\r\n      result = { success: true, data: profile }\r\n    }\r\n\r\n    return result\r\n  } catch (error: any) {\r\n    // Check if this is a Next.js redirect error - if so, re-throw it\r\n    if (error && typeof error === 'object' && 'digest' in error && error.digest?.startsWith('NEXT_REDIRECT')) {\r\n      throw error\r\n    }\r\n    console.error('Error in updateUserProfile:', error)\r\n    return { success: false, error: error.message || 'Failed to update profile' }\r\n  }\r\n}\r\n\r\n/**\r\n * Upsert user profile (create or update in one operation)\r\n * This is the recommended method as it handles both cases automatically\r\n */\r\nexport async function upsertUserProfile(input: UserProfileInput): Promise<UserProfileResponse> {\r\n  try {\r\n    // Use getServerSession instead of requireAuth to avoid redirect issues\r\n    // If no session, return error instead of redirecting\r\n    const user = await getServerSession()\r\n    if (!user) {\r\n      return { success: false, error: 'Authentication required. Please log in.' }\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    // Validate required fields\r\n    if (!input.company_name || !input.registration_number || !input.industry) {\r\n      return { success: false, error: 'Missing required fields' }\r\n    }\r\n\r\n    const { data: profile, error } = await supabase\r\n      .from('user_profiles')\r\n      .upsert(\r\n        {\r\n          user_id: user.id,\r\n          company_name: input.company_name,\r\n          registration_number: input.registration_number,\r\n          industry: input.industry,\r\n          business_description: input.business_description,\r\n          annual_revenue: input.annual_revenue,\r\n          employees_count: input.employees_count,\r\n          years_in_business: input.years_in_business,\r\n          location: input.location,\r\n          funding_requirements: input.funding_requirements as any,\r\n        },\r\n        {\r\n          onConflict: 'user_id',\r\n        }\r\n      )\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error('Error upserting user profile:', error)\r\n      return { success: false, error: error.message }\r\n    }\r\n\r\n    return { success: true, data: profile }\r\n  } catch (error: any) {\r\n    // Check if this is a Next.js redirect error - if so, re-throw it\r\n    if (error && typeof error === 'object' && 'digest' in error && error.digest?.startsWith('NEXT_REDIRECT')) {\r\n      throw error\r\n    }\r\n    console.error('Error in upsertUserProfile:', error)\r\n    return { success: false, error: error.message || 'Failed to save profile' }\r\n  }\r\n}\r\n\r\n/**\r\n * Check if user profile is complete (has all required onboarding data)\r\n * Returns true if all required fields are filled, false otherwise\r\n */\r\nexport async function isProfileComplete(): Promise<boolean> {\r\n  try {\r\n    // Use getServerSession instead of requireAuth to avoid redirect issues\r\n    const user = await getServerSession()\r\n    if (!user) {\r\n      return false\r\n    }\r\n    const supabase = await createClient()\r\n\r\n    const { data: profile, error } = await supabase\r\n      .from('user_profiles')\r\n      .select('*')\r\n      .eq('user_id', user.id)\r\n      .maybeSingle()\r\n\r\n    // If no profile exists or error occurred, profile is incomplete\r\n    if (error || !profile) {\r\n      return false\r\n    }\r\n\r\n    // Check all required fields are filled\r\n    // Basic business information\r\n    if (!profile.company_name || profile.company_name.trim() === '') return false\r\n    if (!profile.registration_number || profile.registration_number.trim() === '') return false\r\n    if (!profile.industry || profile.industry.trim() === '') return false\r\n    if (!profile.business_description || profile.business_description.trim() === '') return false\r\n    if (!profile.location || profile.location.trim() === '') return false\r\n\r\n    // Business metrics\r\n    if (profile.annual_revenue === null || profile.annual_revenue === undefined) return false\r\n    if (profile.employees_count === null || profile.employees_count === undefined) return false\r\n    if (profile.years_in_business === null || profile.years_in_business === undefined) return false\r\n\r\n    // Funding requirements (JSONB field)\r\n    if (!profile.funding_requirements || typeof profile.funding_requirements !== 'object') return false\r\n    \r\n    const fundingReqs = profile.funding_requirements as any\r\n    if (!fundingReqs.amount_needed || fundingReqs.amount_needed === null || fundingReqs.amount_needed === undefined) return false\r\n    if (!fundingReqs.funding_purpose || fundingReqs.funding_purpose.trim() === '') return false\r\n\r\n    // All required fields are present and filled\r\n    return true\r\n  } catch (error: any) {\r\n    console.error('Error checking profile completion:', error)\r\n    // On error, assume incomplete to be safe\r\n    return false\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 518, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/liqui/OneDrive/Desktop/ai-funding-platform/.next-internal/server/app/onboarding/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {createUserRecord as '60b59951fd5143ab30439d8982ae3ae4d3d966f67f'} from 'ACTIONS_MODULE0'\nexport {isProfileComplete as '00bb7fc876b5d429ebf45c202731d453991d49206f'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":";AAAA;AACA"}}]
}